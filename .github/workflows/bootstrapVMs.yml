name: build provisioningVM
on: push

jobs:
  build-VM:
    name: Build provisioningVM
    runs-on: iede
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Terraform Init
        working-directory: terraform-azure
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform-azure
        run: terraform apply -auto-approve

      - name: Output Public IP Addresses
        working-directory: terraform-azure
        run: terraform output -json > /opt/pertclinic/terraform-azure/ip_addresses.json

      - name: Check IP Addresses File
        run: cat /opt/pertclinic/terraform-azure/ip_addresses.json

      - name: Change Permissions for Inventory Script
        run: chmod +x /opt/pertclinic/terraform-azure/generate_inventory.sh

      - name: Generate Ansible Inventory
        working-directory: /opt/pertclinic/terraform-azure
        run: ./generate_inventory.sh ip_addresses.json

      - name: Check Hosts File
        run: cat /opt/pertclinic/terraform-azure/hosts

      - name: Testing Playbook
        run: ansible-playbook -i /opt/pertclinic/terraform-azure/hosts /opt/pertclinic/ansible/main-testing.yml
      - name: testing playbook
        run: ansible-playbook -i hosts /opt/pertclinic/ansible/main-testing.yml
      
