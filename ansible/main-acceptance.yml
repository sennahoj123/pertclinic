## playbook to execute selenium vm
- name: install testing vm
  hosts: Acceptance
  become: yes
  remote_user: adminuser
  roles:
    - Install-openJDK
    - Install-maven
    #- Install-jmeter
    # - Install-terraform&azure-cli
    # - Install-ansi
    - Install-chrome
    # - Install-github-runner
    #- Install-docker
    - Install-tomcat
    - Install-selenium

  
  tasks:
    - name: Set MAVEN_OPTS environment variable
      set_fact:
        MAVEN_OPTS: "--add-opens java.base/java.lang=ALL-UNNAMED"

    - name: Build WAR file
      shell:
        cmd: mvn clean package --file /opt/pertclinic/pom.xml
        chdir: /opt/pertclinic
      environment:
        MAVEN_OPTS: "{{ MAVEN_OPTS }}"

    - name: Set permissions for the WAR file
      ansible.builtin.file:
        path: /opt/pertclinic/target/petclinic.war
        mode: '0777'
    
      register: maven_build_result
      ignore_errors: true

    - name: Check if the WAR file exists
      stat:
        path: "/opt/pertclinic/target/petclinic.war"        
      register: war_file_status
      failed_when: false
      when: maven_build_result is succeeded

    - name: Copy WAR file to Tomcat webapps directory
      ansible.builtin.shell:
        cmd: cp /opt/pertclinic/target/petclinic.war /opt/tomcat/webapps/petclinic.war 

    - name: Create Selenium configuration file
      ansible.builtin.copy:
        dest: /opt/pertclinic/selenium-config.js
        content: |
          module.exports = {
            baseUrl: 'http://localhost:8080',
            browserName: 'chrome',
            browserOptions: [
              '--headless',
              '--no-sandbox',
              '--disable-dev-shm-usage',
              '--remote-debugging-port=9222',
              '--disable-gpu',
              '--binary=/usr/bin/google-chrome'
            ]
          };

    - name: Run Selenium test with chrome
      ansible.builtin.shell: 
        cmd: selenium-side-runner /opt/pertclinic/selenium-config.js /opt/pertclinic/PetclinicSeleniumTest.side
      register: selenium_test
      become: yes

    - name: Print selenium-side-runner output
      ansible.builtin.debug:
        var: selenium_test.stdout_lines